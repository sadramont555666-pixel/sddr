# گزارش رفع مشکل ارسال پیامک با کاوه‌نگار

## ✅ مشکلات رفع شده

### 1. **پیاده‌سازی REST API به جای SDK**
- ❌ **قبل**: استفاده از پکیج `kavenegar` و متد SDK
- ✅ **بعد**: استفاده مستقیم از REST API کاوه‌نگار
- **مزایا**: 
  - عدم وابستگی به SDK
  - لاگ کامل درخواست و پاسخ
  - کنترل بیشتر روی خطاها

### 2. **رفع مشکل متغیرهای محیطی**
- ❌ **قبل**: فقط از `KAVENEGAR_LINE_NUMBER` استفاده می‌کرد
- ✅ **بعد**: از همه متغیرهای زیر پشتیبانی می‌کند (با اولویت):
  - `KAVENEGAR_LINE_NUMBER`
  - `KAVENEGAR_SENDER_NUMBER` ⭐ (اصلی شما)
  - `SMS_SENDER`
  - `KAVENEGAR_SENDER`
  - پیش‌فرض: `2000660110`

### 3. **بهبود شناسایی پاسخ موفق**
- ✅ بررسی `json.return.status === 200`
- ✅ لاگ واضح برای موفقیت و خطا
- ✅ نمایش پیام خطای کاوه‌نگار در کنسول

### 4. **پشتیبانی از حالت تست محلی**
- ✅ متغیر `TEST_ECHO_OTP=true`
- ✅ عدم ارسال واقعی پیامک در حالت تست
- ✅ لاگ کد در کنسول برای تست

### 5. **بهبود تابع normalizeIranPhone**
- ✅ پشتیبانی از همه فرمت‌های معمول ایرانی
- ✅ خروجی یکسان: `09xxxxxxxxx`
- ✅ افزودن `0` به شماره‌هایی که با `9` شروع می‌شوند

## 📋 فایل‌های تغییر یافته

### 1. `src/app/api/utils/sms.js` ⭐ **اصلی**
```javascript
// قبل: SDK + Twilio
// بعد: REST API خالص کاوه‌نگار

export function normalizeIranPhone(raw) { ... }
export async function sendSMS(phone, message, options = {}) { ... }
export async function notifySangshekanOnSignup(userPhoneNumber) { ... }
```

### 2. `env.example`
```env
KAVENEGAR_API_KEY="YOUR_API_KEY_HERE"
KAVENEGAR_SENDER_NUMBER="2000660110"
TEST_ECHO_OTP="false"  # ⭐ جدید
```

### 3. `KAVENEGAR_SETUP_GUIDE.md` ⭐ **جدید**
راهنمای کامل رفع خطای 501 و راه‌اندازی کاوه‌نگار

## 🔴 علت خطای Status 501

```json
{
  "return": {
    "status": 501,
    "message": "امکان ارسال پیامک فقط به شماره صاحب حساب داده شده است"
  }
}
```

### این خطا **از طرف کاوه‌نگار** است، نه کد شما!

**دلیل**: حساب کاوه‌نگار شما در **حالت تست** است و محدودیت دارد.

## ✅ راه‌حل‌ها (به ترتیب اولویت)

### روش ۱: حالت تست محلی (فوری - بدون هزینه)

در فایل `.env` یا در Liara:

```env
TEST_ECHO_OTP=true
```

**نتیجه**:
- ✅ ارسال واقعی انجام نمی‌شود
- ✅ کد در کنسول نمایش داده می‌شود
- ✅ فلوی ثبت‌نام کامل کار می‌کند
- ✅ برای توسعه و تست مناسب است

### روش ۲: افزودن شماره تست به پنل کاوه‌نگار (۵ دقیقه)

1. وارد پنل شوید: https://panel.kavenegar.com
2. منو: **تنظیمات → شماره‌های تست**
3. شماره `09928254081` را اضافه کنید
4. اکنون می‌توانید به این شماره پیامک بفرستید

### روش ۳: احراز هویت و فعال‌سازی حساب (۱-۲ روز)

برای استفاده تولیدی (production):

1. **احراز هویت**:
   - منو: تنظیمات → احراز هویت
   - بارگذاری مدارک شناسایی
   - انتظار تایید (۱-۲ روز کاری)

2. **شارژ حساب**:
   - منو: خدمات مالی → افزایش اعتبار
   - حداقل ۱۰۰,۰۰۰ ریال

3. **فعال‌سازی خط**:
   - خط `2000660110` به صورت خودکار فعال می‌شود

## 🧪 تست کد

### تست ۱: حالت Echo (بدون ارسال واقعی)

```bash
# در .env
TEST_ECHO_OTP=true

# سپس در مرورگر
# ثبت‌نام با هر شماره‌ای
# کد در کنسول سرور نمایش داده می‌شود
```

**خروجی مورد انتظار در کنسول**:
```
[TEST_ECHO_OTP] sendSMS -> receptor:09xxxxxxxxx message:کد تایید شما: 123456
```

### تست ۲: ارسال واقعی (پس از رفع محدودیت)

```bash
# در .env
TEST_ECHO_OTP=false
KAVENEGAR_API_KEY=your-key
KAVENEGAR_SENDER_NUMBER=2000660110

# سپس ثبت‌نام کنید
```

**خروجی موفق در کنسول**:
```
Kavenegar send response status: 200 body: {"return":{"status":200,...},"entries":[...]}
✅ Kavenegar send successful
```

## 📊 بررسی لاگ‌ها

### ✅ موفق
```
Kavenegar send response status: 200 body: {"return":{"status":200},"entries":[...]}
✅ Kavenegar send successful
```

### ❌ خطای 501 (محدودیت حساب)
```
Kavenegar send response status: 501 body: {"return":{"status":501,"message":"امکان ارسال پیامک فقط به شماره صاحب حساب داده شده است"}}
⚠️ Kavenegar returned error: 501 امکان ارسال پیامک فقط به شماره صاحب حساب داده شده است
```

### ❌ خطای 412 (sender نامعتبر)
```
Kavenegar send response status: 412 body: {"return":{"status":412,"message":"ارسال کننده نامعتبر است"}}
⚠️ Kavenegar returned error: 412 ارسال کننده نامعتبر است
```

## 🎯 توصیه‌ها

### برای توسعه محلی:
```env
TEST_ECHO_OTP=true
```

### برای استیج/تست:
```env
TEST_ECHO_OTP=false
KAVENEGAR_API_KEY=your-test-key
# شماره‌های تست را در پنل اضافه کنید
```

### برای پروداکشن:
```env
TEST_ECHO_OTP=false
KAVENEGAR_API_KEY=your-production-key
KAVENEGAR_SENDER_NUMBER=2000660110
# حساب باید احراز هویت شده و شارژ شده باشد
```

## 📞 پشتیبانی

اگر همچنان مشکل دارید:

1. **بررسی لاگ‌های سرور**: کل پاسخ کاوه‌نگار را بررسی کنید
2. **تماس با کاوه‌نگار**: ۰۲۱-۹۱۰۰۳۹۰۰
3. **ارسال تیکت**: https://panel.kavenegar.com/support

## ✅ چک‌لیست نهایی

- [ ] فایل `.env` دارای `KAVENEGAR_API_KEY` است
- [ ] فایل `.env` دارای `KAVENEGAR_SENDER_NUMBER` است
- [ ] برای تست محلی: `TEST_ECHO_OTP=true` تنظیم شده
- [ ] برای پروداکشن: حساب کاوه‌نگار احراز هویت شده
- [ ] برای پروداکشن: حساب کاوه‌نگار شارژ شده
- [ ] تست ثبت‌نام انجام شده و کد دریافت شده

## 🔒 امنیت

- ✅ API Key در URL به صورت encode شده ارسال می‌شود
- ✅ در لاگ‌ها API Key نمایش داده نمی‌شود (با *** جایگزین می‌شود)
- ✅ پیام‌ها به صورت UTF-8 encode می‌شوند

---

**نتیجه**: کد شما ✅ **صحیح** و **کامل** است. فقط باید یکی از راه‌حل‌های بالا را برای رفع محدودیت حساب کاوه‌نگار اجرا کنید.

