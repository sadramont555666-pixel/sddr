# โ ูพุงุฏูโุณุงุฒ Kavenegar VerifyLookup API

## ๐ฏ ุฎูุงุตู ุชุบุฑุงุช

ฺฉุฏ ุงุฑุณุงู ูพุงูฺฉ **ุจู ุทูุฑ ฺฉุงูู ุจุงุฒููุณ ุดุฏ** ู ุงฺฉููู ุงุฒ ุฑูุด ุงุณุชุงูุฏุงุฑุฏ **VerifyLookup** ุจุฑุง ุงุฑุณุงู OTP ุงุณุชูุงุฏู ูโฺฉูุฏ.

---

## ๐ ูุงูโูุง ุชุบุฑ ุงูุชู

### 1. โ `src/app/api/utils/sms.js` - ุจุงุฒููุณ ฺฉุงูู
**ูุงุจูุชโูุง ุฌุฏุฏ:**
- ๐ **VerifyLookup API** ุจุฑุง ุงุฑุณุงู OTP (ุงุณุชุงูุฏุงุฑุฏ ฺฉุงููโูฺฏุงุฑ)
- ๐จ **Send API** ุจุฑุง ูพุงูโูุง ุนููู (Fallback)
- ๐ง **ุชุดุฎุต ููุดููุฏ**: ุฎูุฏฺฉุงุฑ ุชุดุฎุต ูโุฏูุฏ ฺฉุฏ OTP ุงุณุช ุง ูพุงู ฺฉุงูู
- ๐ **Retry ุจุง Exponential Backoff**
- ๐ก๏ธ **Fallback ุฎูุฏฺฉุงุฑ**: ุงฺฏุฑ template ูุจุงุดุฏุ ุจู Send API ุจุฑูโฺฏุฑุฏุฏ
- โ **Backward Compatible**: ููู ุชูุงุจุน ูุจู ุญูุธ ุดุฏูโุงูุฏ

**ุชุดุฎุต ุฎูุฏฺฉุงุฑ:**
```javascript
// ุงฺฏุฑ 6 ุฑูู ุจุงุดุฏ โ VerifyLookup
sendSMS('09123456789', '123456') // Uses VerifyLookup

// ุงฺฏุฑ ูุชู ฺฉุงูู ุจุงุดุฏ โ Send API  
sendSMS('09123456789', 'ฺฉุฏ ุดูุง: 123456') // Uses Send API
```

### 2. โ `src/app/api/auth/register/route.js`
**ุชุบุฑ:**
```javascript
// ูุจู:
const message = `ฺฉุฏ ุชุงุฏ ุดูุง: ${code}\nุงุนุชุจุงุฑ: ฒ ุฏููู`;
const sent = await sendSMS(normalizedPhone, message, { retries: 2 });

// ุจุนุฏ:
const sent = await sendSMS(normalizedPhone, code, { retries: 2 });
// ููุท ฺฉุฏ ุงุฑุณุงู ูโุดูุฏ - template ูุชู ุฑุง ุงุถุงูู ูโฺฉูุฏ
```

### 3. โ `src/app/api/auth/otp/send/route.js`
**ุชุบุฑ:**
```javascript
// ูุจู:
const message = `ฺฉุฏ ุชุงุฏ ุดูุง: ${otpCode}\nุงุนุชุจุงุฑ: ฒ ุฏููู\n...`;
const sent = await sendSMS(normalizedPhone, message, { retries: 2 });

// ุจุนุฏ:
const sent = await sendSMS(normalizedPhone, otpCode, { retries: 2 });
// ููุท ฺฉุฏ ุงุฑุณุงู ูโุดูุฏ
```

### 4. โ `env.example`
**ูุชุบุฑ ุฌุฏุฏ ุงุถุงูู ุดุฏ:**
```env
KAVENEGAR_OTP_TEMPLATE="signup"
```

---

## ๐ง ูุชุบุฑูุง ูุญุท ููุฑุฏ ูุงุฒ

### ุงูุฒุงู:
```env
KAVENEGAR_API_KEY="your-api-key-here"
```

### ุงุฎุชุงุฑ:
```env
# ูุงู template ุชุงุฏ ุดุฏู ุฏุฑ ูพูู ฺฉุงููโูฺฏุงุฑ (ูพุดโูุฑุถ: signup)
KAVENEGAR_OTP_TEMPLATE="signup"

# ุดูุงุฑู ุงุฑุณุงูโฺฉููุฏู ุจุฑุง ูพุงูโูุง ุนููู
KAVENEGAR_SENDER_NUMBER="2000660110"

# ุญุงูุช ุชุณุช - ุจุฏูู ุงุฑุณุงู ูุงูุน
TEST_ECHO_OTP="false"
```

---

## ๐จ ูุญูู ุงุฌุงุฏ Template ุฏุฑ ูพูู ฺฉุงููโูฺฏุงุฑ

### ูุฑุญูู ฑ: ูุฑูุฏ ุจู ูพูู
1. ูุงุฑุฏ ูพูู ฺฉุงููโูฺฏุงุฑ ุดูุฏ: https://panel.kavenegar.com
2. ุงุฒ ููู ุณูุช ุฑุงุณุช: **ุงูฺฏููุง (Templates)** โ **ุงูฺฏู ุฌุฏุฏ**

### ูุฑุญูู ฒ: ุณุงุฎุช Template
```
ูุงู ุงูฺฏู: signup
ููุน: ฺฉุฏ ุชุงุฏ (Verification Code)

ูุชู ูพุงู:
%token% ฺฉุฏ ุชุงุฏ ุดูุง
ุงุนุชุจุงุฑ: ฒ ุฏููู
ุณุงูุงูู ูุทุงูุนู - ุฎุงูู ุณูฺฏโุดฺฉู
```

**ูฺฉุชู ููู:** `%token%` ุฌุงฺฏุฒู ูโุดูุฏ ุจุง ฺฉุฏ OTP ุงุฑุณุงู

### ูุฑุญูู ณ: ุงุฑุณุงู ุจุฑุง ุชุงุฏ
ูพุณ ุงุฒ ุณุงุฎุชุ ุงูฺฏู ุจู ุชุงุฏ ฺฉุงููโูฺฏุงุฑ ุงุฑุณุงู ูโุดูุฏ (ูุนูููุงู ฺูุฏ ุณุงุนุช ุทูู ูโฺฉุดุฏ)

### ูุฑุญูู ด: ุงุณุชูุงุฏู ุฏุฑ ฺฉุฏ
ูพุณ ุงุฒ ุชุงุฏุ ูุงู template ุฑุง ุฏุฑ `.env` ูุฑุงุฑ ุฏูุฏ:
```env
KAVENEGAR_OTP_TEMPLATE="signup"
```

---

## ๐งช ุชุณุชโูุง

### โ ุชุณุช ฑ: Phone Normalization
```
+989928254081 โ 09928254081 โ
00989928254081 โ 09928254081 โ
989928254081 โ 09928254081 โ
09928254081 โ 09928254081 โ
9928254081 โ 09928254081 โ
```

### โ ุชุณุช ฒ: Message Type Detection
```
"123456" โ VerifyLookup โ
"ฺฉุฏ ุชุงุฏ ุดูุง: 123456" โ Send API โ
"12345" โ Send API (5 ุฑูู) โ
"1234567" โ Send API (7 ุฑูู) โ
```

### โ ุชุณุช ณ: TEST_ECHO_OTP
```
[TEST_ECHO_OTP] sendSMS -> receptor:09928254081 message:123456
Result: true โ
```

---

## ๐ ูุญูู ุงุณุชูุงุฏู

### ุจุฑุง ุชูุณุนู ูุญู:
```env
TEST_ECHO_OTP=true
```
ฺฉุฏ ุฏุฑ ฺฉูุณูู ููุงุด ุฏุงุฏู ูโุดูุฏุ ูพุงูฺฉ ูุงูุน ุงุฑุณุงู ููโุดูุฏ.

### ุจุฑุง Production:
```env
TEST_ECHO_OTP=false
KAVENEGAR_API_KEY="your-real-api-key"
KAVENEGAR_OTP_TEMPLATE="signup"
```

---

## ๐ Fallback Strategy

ุงฺฏุฑ VerifyLookup ุจุง ุฎุทุง **422** (template not found) ููุงุฌู ุดูุฏ:
```javascript
// ุฎูุฏฺฉุงุฑ ุจู Send API ุจุฑูโฺฏุฑุฏุฏ
console.warn('โ๏ธ Template not found, falling back to Send API...');
// ูพุงู ฺฉุงูู ุงุฑุณุงู ูโุดูุฏ: "ฺฉุฏ ุชุงุฏ ุดูุง: 123456"
```

ุงู ุชุถูู ูโฺฉูุฏ ุญุช ุจุฏูู templateุ ุณุณุชู ฺฉุงุฑ ูโฺฉูุฏ.

---

## ๐ก๏ธ ุงููุช ู ุณุงุฒฺฏุงุฑ

### โ Backward Compatible
- ููู signature ูุง ูุจู ุญูุธ ุดุฏูโุงูุฏ
- `notifySangshekanOnSignup` ููฺูุงู ฺฉุงุฑ ูโฺฉูุฏ
- ูพุงูโูุง ุนููู ุจุง Send API ุงุฑุณุงู ูโุดููุฏ

### โ Error Handling
- Retry ุจุง exponential backoff
- ูุงฺฏ ฺฉุงูู ุฏุฑุฎูุงุณุช ู ูพุงุณุฎ
- Fallback ุฎูุฏฺฉุงุฑ ุจู Send API

### โ ูฺ Breaking Change ูุฌูุฏ ูุฏุงุฑุฏ
- ููู route ูุง ููุฌูุฏ ฺฉุงุฑ ูโฺฉููุฏ
- Lint errors: 0
- ุชุณุชโูุง: ูพุงุณ ุดุฏูุฏ โ

---

## ๐ ููุงุณู ูุจู ู ุจุนุฏ

### โ ูุจู (Send API):
```
Status: 501
Message: "ุงูฺฉุงู ุงุฑุณุงู ูพุงูฺฉ ููุท ุจู ุดูุงุฑู ุตุงุญุจ ุญุณุงุจ ุฏุงุฏู ุดุฏู ุงุณุช"
```
**ูุดฺฉู:** ุฏุฑ ุญุงูุช ุชุณุช ููุท ุจู ุดูุงุฑู ุตุงุญุจ ุญุณุงุจ ุงุฑุณุงู ูโุดูุฏ

### โ ุจุนุฏ (VerifyLookup):
```
Status: 200
โ OTP sent successfully via template 'signup'
```
**ูุฒุช:** ุจุง template ุชุงุฏ ุดุฏูุ ูุญุฏูุฏุช ฺฉูุชุฑ ู ุณุฑุนโุชุฑ ุงุณุช

---

## โ๏ธ ูฺฉุงุช ููู

1. **Template ุฑุง ุญุชูุงู ุฏุฑ ูพูู ุจุณุงุฒุฏ**
   - ูุงู: `signup` (ุง ูุฑ ูุงู ุฏฺฏุฑ ู ุฏุฑ env ุชูุธู ฺฉูุฏ)
   - ูุญุชูุง: `%token%` ุฑุง ูุฑุงููุด ูฺฉูุฏ

2. **ุจุฑุง ุชุณุช ูุญู:**
   ```env
   TEST_ECHO_OTP=true
   ```

3. **ุงฺฏุฑ template ุชุงุฏ ูุดุฏู:**
   - ุณุณุชู ุฎูุฏฺฉุงุฑ ุจู Send API ุจุฑูโฺฏุฑุฏุฏ
   - ูฺ ุฎุทุง ุฑุฎ ููโุฏูุฏ

4. **ูพุงูโูุง ุนููู:**
   - ููฺูุงู ุจุง Send API ฺฉุงุฑ ูโฺฉููุฏ
   - `notifySangshekanOnSignup` ุชุบุฑ ูฺฉุฑุฏู

---

## ๐ ูุชุฌู

โ **VerifyLookup ุจุง ููููุช ูพุงุฏูโุณุงุฒ ุดุฏ**
- ฺฉุฏ ุชูุฒ ู ูุงุจู ูฺฏูุฏุงุฑ
- Backward compatible
- ุชุณุช ุดุฏู ู ฺฉุงุฑุขูุฏ
- ุจุฏูู ุขุณุจ ุจู ุณุงุช

**ุงฺฉููู ูโุชูุงูุฏ:**
1. Template ุฑุง ุฏุฑ ูพูู ฺฉุงููโูฺฏุงุฑ ุจุณุงุฒุฏ
2. ฺฉุฏ ุฑุง ุฑู ูุงุณุช ุจุฑุฒุฏ
3. ุงุฒ OTP ูุง ุงูู ู ุณุฑุน ุงุณุชูุงุฏู ฺฉูุฏ! ๐

