# 📘 راهنمای راه‌اندازی حساب ادمین (مشاور)

## 🎯 هدف
این راهنما مراحل ساخت اولین حساب کاربری ادمین (مشاور تحصیلی) را در سامانه گزارش‌گیری مطالعه توضیح می‌دهد.

---

## ⚙️ پیش‌نیازها

### 1. تنظیم متغیرهای محیطی (.env)

در فایل `.env` واقع در `create/apps/web/.env`، دو متغیر زیر را اضافه کنید:

```env
# کلید امنیتی برای احراز هویت درخواست ساخت ادمین
ADMIN_SETUP_SECRET=your-very-secure-secret-key-here

# رمز عبور پیش‌فرض برای حساب ادمین
DEFAULT_ADVISOR_PASSWORD=Your_Strong_Password_123
```

**توجه امنیتی:**
- از یک کلید قوی و تصادفی برای `ADMIN_SETUP_SECRET` استفاده کنید
- رمز عبور باید حداقل ۸ کاراکتر و شامل حروف بزرگ، کوچک و اعداد باشد
- **هیچ‌گاه** این مقادیر را در Git commit نکنید

### 2. راه‌اندازی مجدد سرور

پس از تغییر `.env`، سرور را مجدداً راه‌اندازی کنید:

```powershell
# در مسیر create/apps/web
npm run dev
```

---

## 🚀 ساخت حساب ادمین

### روش 1: استفاده از curl.exe (Windows PowerShell)

```powershell
curl.exe -X POST "http://localhost:4000/api/admin/create-advisor" `
  -H "x-admin-secret: your-very-secure-secret-key-here" `
  -H "Content-Type: application/json" `
  -d "{}"
```

### روش 2: استفاده از Invoke-RestMethod (PowerShell Native)

```powershell
$headers = @{
    'x-admin-secret' = 'your-very-secure-secret-key-here'
    'Content-Type' = 'application/json'
}

Invoke-RestMethod -Uri 'http://localhost:4000/api/admin/create-advisor' `
  -Method Post `
  -Headers $headers `
  -Body '{}'
```

### روش 3: استفاده از Postman یا Insomnia

- **Method:** POST
- **URL:** `http://localhost:4000/api/admin/create-advisor`
- **Headers:**
  - `x-admin-secret`: `your-very-secure-secret-key-here`
  - `Content-Type`: `application/json`
- **Body:** `{}` (خالی)

---

## ✅ پاسخ موفقیت‌آمیز

اگر عملیات موفق باشد، پاسخ زیر را دریافت می‌کنید:

```json
{
  "success": true,
  "message": "حساب ادمین با موفقیت ایجاد شد",
  "user": {
    "id": "cmgjn81r40000uiig079papao",
    "name": "خانم سنگ شکن (مشاور تحصیلی)",
    "phone": "09923182082",
    "role": "ADMIN",
    "isVerified": true,
    "createdAt": "2025-10-09T16:39:51.520Z"
  }
}
```

اگر حساب قبلاً وجود داشته باشد، پیام تغییر می‌کند به:
```json
{
  "message": "حساب ادمین با موفقیت به‌روزرسانی شد"
}
```

---

## ❌ خطاهای احتمالی

### 1. خطای 403 - دسترسی غیرمجاز

```json
{
  "error": "دسترسی غیرمجاز. هدر x-admin-secret معتبر نیست."
}
```

**راه حل:** مطمئن شوید که مقدار `x-admin-secret` در درخواست با `ADMIN_SETUP_SECRET` در `.env` یکسان است.

### 2. خطای 500 - پیکربندی نادرست

```json
{
  "error": "سرور به‌درستی پیکربندی نشده است. لطفاً ADMIN_SETUP_SECRET را تنظیم کنید."
}
```

**راه حل:** متغیر `ADMIN_SETUP_SECRET` را در `.env` تنظیم کرده و سرور را ری‌استارت کنید.

### 3. خطای 409 - داده تکراری

```json
{
  "error": "این شماره موبایل قبلاً ثبت شده است.",
  "code": "DUPLICATE_ENTRY"
}
```

**راه حل:** این خطا نباید رخ دهد زیرا کد به‌صورت خودکار رکورد موجود را به‌روزرسانی می‌کند. اگر دیدید، احتمالاً مشکلی در دیتابیس وجود دارد.

### 4. خطای دیتابیس

```json
{
  "error": "خطا در اتصال به دیتابیس. لطفاً تنظیمات DATABASE_URL را بررسی کنید.",
  "code": "DB_CONNECTION_ERROR"
}
```

**راه حل:** 
- بررسی کنید PostgreSQL در حال اجراست
- `DATABASE_URL` در `.env` را بررسی کنید
- مطمئن شوید Prisma migrations اجرا شده‌اند: `npx prisma migrate deploy`

---

## 🔐 ورود به حساب ادمین

پس از ساخت موفق حساب ادمین:

1. به صفحه ورود بروید: `http://localhost:4000/account/signin`
2. اطلاعات زیر را وارد کنید:
   - **شماره موبایل:** `09923182082`
   - **رمز عبور:** همان مقداری که در `DEFAULT_ADVISOR_PASSWORD` تنظیم کرده‌اید
3. پس از ورود موفق، به داشبورد ادمین هدایت می‌شوید: `/admin`

---

## 📊 مشخصات حساب ادمین پیش‌فرض

- **نام:** خانم سنگ شکن (مشاور تحصیلی)
- **شماره موبایل:** `09923182082`
- **نقش:** `ADMIN`
- **وضعیت:** فعال و تایید شده

---

## 🔧 عیب‌یابی

### بررسی لاگ‌های سرور

تمام خطاها با جزئیات کامل در کنسول سرور ثبت می‌شوند. اگر با مشکلی مواجه شدید:

1. کنسولی که سرور در آن اجرا می‌شود را بررسی کنید
2. به دنبال خطوط شروع شده با `Admin creation/update error:` بگردید
3. جزئیات کامل خطا شامل stack trace نمایش داده می‌شود

### بررسی دیتابیس

برای اطمینان از ساخت موفق، می‌توانید مستقیماً دیتابیس را بررسی کنید:

```sql
SELECT id, name, phone, role, "isVerified", "createdAt"
FROM "User"
WHERE phone = '09923182082';
```

---

## 🎓 نکات امنیتی

1. **محافظت از کلید:** پس از ساخت حساب ادمین، می‌توانید `ADMIN_SETUP_SECRET` را از `.env` حذف کنید تا از دسترسی غیرمجاز جلوگیری شود.

2. **تغییر رمز عبور:** پس از اولین ورود، حتماً رمز عبور را از طریق پنل کاربری تغییر دهید.

3. **محیط Production:** در محیط تولید، حتماً از HTTPS استفاده کنید و کلیدها را در یک Secret Manager امن نگه‌داری کنید.

---

## 📞 پشتیبانی

اگر با مشکلی مواجه شدید که در این راهنما پوشش داده نشده، لطفاً:
- لاگ‌های کامل سرور را بررسی کنید
- از صحت تنظیمات `.env` اطمینان حاصل کنید
- اتصال به دیتابیس را تست کنید

---

**تاریخ به‌روزرسانی:** ۱۸ مهر ۱۴۰۴  
**نسخه API:** v1.0

