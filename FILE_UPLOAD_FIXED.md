# โ ูุดฺฉู ุขูพููุฏ ูุงู ุญู ุดุฏ!

## ๐ ูุดฺฉู ุงุตู

ุฎุทุง `ERR_CONNECTION_CLOSED` ุจู ุฏูู **ุนุฏู ุชูุธู Cloudflare R2 credentials** ุจูุฏ.

---

## โ ุฑุงูโุญู ูพุงุฏูโุณุงุฒ ุดุฏู

ฺฉ ุณุณุชู **Fallback ููุดููุฏ** ูพุงุฏูโุณุงุฒ ุดุฏ:

1. **ุงุจุชุฏุง** ุชูุงุด ูโฺฉูุฏ ุงุฒ R2 (Cloudflare) ุงุณุชูุงุฏู ฺฉูุฏ
2. **ุฏุฑ ุตูุฑุช ุฎุทุง** ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุจู ุขูพููุฏ ูุญู ุชุบุฑ ูโฺฉูุฏ

ุงู ุจู ุดูุง ุงุฌุงุฒู ูโุฏูุฏ:
- โ **ููุฑุงู** ุดุฑูุน ุจู ฺฉุงุฑ ฺฉูุฏ (ุจุฏูู ูุงุฒ ุจู R2)
- โ **ุจุนุฏุงู** R2 ุฑุง ุชูุธู ฺฉูุฏ ุจุฑุง Production

---

## ๐ ูุงูโูุง ุชุบุฑ ุงูุชู

### 1. API ุขูพููุฏ ูุญู (ุฌุฏุฏ) โ
**ูุงู:** `src/app/api/student/reports/upload/route.js`

**ูฺฺฏโูุง:**
- ุขูพููุฏ ูุงูโูุง ุฏุฑ `public/uploads/reports/`
- ูุญุฏูุฏุช ุญุฌู: 200MB
- ููุท ุชุตุงูุฑ ู PDF
- ูุงฺฏโูุง ฺฉุงูู ุจุฑุง ุฏุจุงฺฏ

### 2. Hook ุขูพููุฏ (ุงุตูุงุญ ุดุฏู) โ
**ูุงู:** `src/hooks/student/usePresignedUpload.ts`

**ุชุบุฑุงุช:**
- ุงุจุชุฏุง ุชูุงุด ุจุฑุง R2
- Fallback ุฎูุฏฺฉุงุฑ ุจู Local Upload
- ุจุฑฺฏุฑุฏุงูุฏู ูุฑ ุฏู `fileKey` ู `fileUrl`

### 3. Reports Controller (ุงุตูุงุญ ุดุฏู) โ
**ูุงู:** `src/server/controllers/student/reports.ts`

**ุชุบุฑุงุช:**
- ูพุดุชุจุงู ุงุฒ `fileUrl` ูุณุชูู
- ูพุดุชุจุงู ุงุฒ `fileKey` (R2)
- ูุฏุฑุช ุฎุทุง `getPublicUrl`

### 4. Form Component (ุงุตูุงุญ ุดุฏู) โ
**ูุงู:** `src/components/student/ReportSubmissionForm.tsx`

**ุชุบุฑุงุช:**
- ุงุฑุณุงู ูุฑ ุฏู `fileKey` ู `fileUrl`
- ุณุงุฒฺฏุงุฑ ุจุง ูุฑ ุฏู ุฑูุด ุขูพููุฏ

---

## ๐ ูุญูู ุงุณุชูุงุฏู

### ููุฑุงู ฺฉุงุฑ ูโฺฉูุฏ! (Local Upload)

```bash
# ูฺ ูุงุฒ ุจู ุชูุธูุงุช ุงุถุงู ูุณุช
npm run dev
```

ูุงูโูุง ุฏุฑ `public/uploads/reports/` ุฐุฎุฑู ูโุดููุฏ.

---

## ๐ ุฌุฑุงู ฺฉุงุฑ

```
ฺฉุงุฑุจุฑ ูุงู ุฑุง ุงูุชุฎุงุจ ูโฺฉูุฏ
         โ
usePresignedUpload ุชูุงุด ูโฺฉูุฏ ุงุฒ R2 ุงุณุชูุงุฏู ฺฉูุฏ
         โ
     ุขุง R2 ููุฌูุฏ ุงุณุชุ
    โ           โ
 ุจูู             ุฎุฑ
   โ              โ
R2 Upload    Local Upload
   โ              โ
fileKey      fileUrl
   โ              โ
    โ           โ
      ุงุฑุณุงู ุจู API
         โ
   ุฐุฎุฑู ุฏุฑ ุฏุชุงุจุณ
```

---

## ๐ง ุชูุธู R2 (ุงุฎุชุงุฑ - ุจุฑุง Production)

ุงฺฏุฑ ูโุฎูุงูุฏ ุงุฒ R2 ุงุณุชูุงุฏู ฺฉูุฏ:

### ูุฑุญูู 1: ุฏุฑุงูุช Credentials
1. ูุฑูุฏ ุจู [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. ุฑูุชู ุจู `R2 Object Storage`
3. ุงุฌุงุฏ Bucket
4. ุฏุฑุงูุช API Token

### ูุฑุญูู 2: ุชูุธู .env
```env
R2_ENDPOINT="https://YOUR_ACCOUNT_ID.r2.cloudflarestorage.com"
R2_ACCESS_KEY_ID="your-access-key-id"
R2_SECRET_ACCESS_KEY="your-secret-access-key"
R2_BUCKET="your-bucket-name"
ASSET_PUBLIC_BASE_URL="https://your-bucket-name.YOUR_ACCOUNT_ID.r2.cloudflarestorage.com"
```

### ูุฑุญูู 3: ุฑุงูโุงูุฏุงุฒ ูุฌุฏุฏ
```bash
npm run dev
```

ุณุณุชู ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ ุงุฒ R2 ุงุณุชูุงุฏู ุฎูุงูุฏ ฺฉุฑุฏ! ๐

---

## ๐งช ุชุณุช

### ุชุณุช ุขูพููุฏ ูุงู:

```bash
# 1. ุฑุงูโุงูุฏุงุฒ ุณุฑูุฑ
npm run dev

# 2. Login ุฏุงูุดโุขููุฒ
# 3. ุฑูุชู ุจู ุตูุญู ุซุจุช ฺฏุฒุงุฑุด
# 4. ุงูุชุฎุงุจ ูุงู (ุชุตูุฑ ุง PDF)
# 5. ูพุฑ ฺฉุฑุฏู ูุฑู
# 6. ฺฉูฺฉ "ุซุจุช ฺฏุฒุงุฑุด"
```

**ูุชุฌู ููุฑุฏ ุงูุชุธุงุฑ:**
- โ Progress bar ููุงุด ุฏุงุฏู ูโุดูุฏ
- โ ูพุงู "ูุงู ุจุง ููููุช ุขูพููุฏ ุดุฏ"
- โ ฺฏุฒุงุฑุด ุจุง ูุงู ุฐุฎุฑู ูโุดูุฏ
- โ ุฏุฑ ูพูู ุงุฏููุ ููฺฉ "ูุดุงูุฏู" ฺฉุงุฑ ูโฺฉูุฏ

---

## ๐ ูุงฺฏโูุง

### Console ูุฑูุฑฺฏุฑ:
```
๐ค [usePresignedUpload] Starting upload for: test.jpg
โ๏ธ [usePresignedUpload] Presigned URL failed, falling back to direct upload
๐ค [usePresignedUpload] Using direct upload
โ [usePresignedUpload] Upload complete: /uploads/reports/xxx.jpg
```

### Terminal ุณุฑูุฑ:
```
๐ค [Upload] Starting file upload...
โ [Upload] User authenticated: clxyz...
๐ [Upload] File details: { name: 'test.jpg', type: 'image/jpeg', size: 54321 }
โ [Upload] File saved: F:\...\public\uploads\reports\xxx.jpg
โ [Upload] Success! URL: /uploads/reports/xxx.jpg
```

---

## โ๏ธ ูฺฉุงุช ููู

### 1. ูุญุฏูุฏุช ุญุฌู ูุงู
- ุญุฏุงฺฉุซุฑ: **200MB**
- ูุงุจู ุชุบุฑ ุฏุฑ `route.js`

### 2. ููุน ูุงูโูุง ูุฌุงุฒ
- ุชุตุงูุฑ: JPG, PNG, GIF, WebP
- ุงุณูุงุฏ: PDF
- ูุงุจู ุชุบุฑ ุฏุฑ `route.js`

### 3. ูุถุง ุฐุฎุฑูโุณุงุฒ
- Local: ูุถุง ุฏุณฺฉ ุณุฑูุฑ
- R2: ูุงูุญุฏูุฏ (ูพูู)

### 4. ุขุฏุฑุณ ูุงูโูุง
- Local: `/uploads/reports/filename.jpg`
- R2: `https://bucket.r2.cloudflarestorage.com/key`

---

## ๐ ูุฒุงุง

| ูฺฺฏ | ูุจู | ุจุนุฏ |
|-------|-----|-----|
| ูุงุฒ ุจู R2 | โ ุงูุฒุงู | โ๏ธ ุงุฎุชุงุฑ |
| ฺฉุงุฑ ุฏุฑ Development | โ ุฎุทุง | โ ููุฑ |
| Setup ูพฺุฏู | โ ุจูู | โ ุฎุฑ |
| Fallback | โ ูุฏุงุฑุฏ | โ ุฏุงุฑุฏ |
| Production Ready | โ ุจูู (ุจุง R2) | โ ุจูู (ูุฑ ุฏู) |

---

## โ ุฎูุงุตู

**ูุดฺฉู:** `ERR_CONNECTION_CLOSED` ุจู ุฏูู ุนุฏู ุชูุธู R2

**ุฑุงูโุญู:**
1. โ API ุขูพููุฏ ูุญู ุงุถุงูู ุดุฏ
2. โ Fallback ููุดููุฏ ูพุงุฏูโุณุงุฒ ุดุฏ
3. โ ูุฑ ุฏู ุฑูุด (R2 ู Local) ูพุดุชุจุงู ูโุดููุฏ
4. โ ููุฑุงู ฺฉุงุฑ ูโฺฉูุฏ ุจุฏูู ูุงุฒ ุจู ุชูุธูุงุช

**ูุชุฌู:** ุขูพููุฏ ูุงู ฺฉุงููุงู ฺฉุงุฑ ูโฺฉูุฏ! ๐

---

**ุชุงุฑุฎ:** 2025-10-12  
**ูุถุนุช:** โ ฺฉุงูู ู ุชุณุช ุดุฏู

